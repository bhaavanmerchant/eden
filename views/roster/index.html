{{extend 'layout.html'}}
<head><script type="text/javascript">
    var current_cell={"r":0,
                      "c":0};
jQuery(document).ready(function(){
    $('#newrole').hide();
    $('#r_varea').hide();
    $('.rems').hide();
    $('.addpf').hide();
    $('.rempf').show();
    $('#addrow').click(function()
        {
        $('#newrole').toggle();
        $('#addrow').hide();
        });
    $('#new_job_role').change(function()
        {
        $('#roster_info_form').submit();
        });
    $('#event').change(function()
        {
        $('#table_info_form').submit();
        });
    $('#project_selector').change(function()
        {
        $('#table_info_form').submit();
        });
    $('#timeframe').change(function()
        {
        $('#table_info_form').submit();
        });
    $('#timeslot').change(function()
        {
        $('#table_info_form').submit();
        });
    $('#vn').on('keypress','#volunteer_quick_search',function(event){
        $('.volunteer_names').each(function(){
            if($('#volunteer_quick_search').val()=='')
            {
            $(this).show();
            }
            else
            {
                if ($(this).html().toLowerCase().search($('#volunteer_quick_search').val().toLowerCase()) == -1)
                {
                $(this).hide();
                }
                else
                {
                $(this).show();
                }
            }
        });
    });

    $('.adds').click(function()
        {
        var cell=$(this).parent();
        cell.addClass('sloted');
        cell.data("sloted",1);
        cell.children('.scelln').html('<a class="addv">Assign</a> {{=IMG(_src="/eden/static/img/star.png",_alt="star",_class="star")}}');
        cell.children('.adds').hide();
        cell.children('.rems').show();
        $('#r_varea').hide();
        $('.aside').show();
        });
    $("#r_table").on("click",".addv",function(event)
       {
        $('#r_varea').show();
        
        $('.aside').hide();
        var cell=$(this).parent().parent();
        current_cell.r=cell.data('row');
        current_cell.c=cell.data('col');
        $.ajax(
            {
            type: "POST",
            url: "{{=URL(c='roster', f='people', args=[table_id, instance_id])}}",
            data: { row: current_cell.r }
            }).done(function( msg ) 
                {
                $("#vn").html(msg);
                });

        });
    $('.remrole').click(function()
        {
        var cell=$(this).parent();
        var url="{{=URL(c='roster', f='del_role', args=[table_id, instance_id])}}"+"/"+cell.data('pos');
        $(location).attr('href',url);
        });
    $('#vn').on('click','.volunteer_names',function(event)
        {
        var vname=$(this).html();
        var vid=$(this).attr('id');
        var duplicate=0;
        $('.vcell').each(function()
            {
            if($(this).data('col')==current_cell.c && $(this).data('vid')==vid)
                {
                duplicate=1;
                };
            });
        if(duplicate==1)
            {
                alert("The same person cannot do more than one role in a given slot.");
            }
        else
            {
            $('.vcell').each(function()
                {
                if($(this).data('row')==current_cell.r && $(this).data('col')==current_cell.c)
                    {
                    var cell_c=vname;
                    $(this).children('.vcelln').html(cell_c);
                    $(this).children('.scelln').html("<a class='remv'>Release</a>");
                    $(this).data("vid",vid);
                    $(this).addClass('allotted');
                    $(this).removeClass('sloted');
                    }; 
                });
           };
        });
    $("#r_table").on("click",".remv",function(event)
        {
        var cell=$(this).parent().parent();
        cell.children('.vcelln').html("");
        cell.removeClass('allotted');
        cell.addClass('sloted');
        cell.data("vid",0);
        $(this).parent().html('<a class="addv">Assign</a> {{=IMG(_src="/eden/static/img/star.png",_alt="star",_class="star")}}');
        });
    $('.rems').click(function()
        {
        $(this).parent().children('.scelln').html("");
        $(this).parent().children('.vcelln').html("");
        $(this).parent().children('.rems').hide();
        $(this).parent().children('.adds').show();
        $(this).parent().data("vid",0);
        $(this).parent().data("sloted",0);
        $(this).parent().removeClass('sloted');
        $(this).parent().removeClass('allotted');
        $(this).parent().removeClass('essential');
        });
    $("#r_table").on("click",".star",function(event)
        {
        $(this).parent().parent().addClass('essential');
        $(this).parent().parent().data("sloted",2)
        });
    $('#cross').click(function()
        {
        $('#r_varea').hide();
        $('.aside').show();
        });
    $('#save').click(function()
    {
    //var roster_dets=new Array();
    //var roster_dets={};
    var roster_array=new Array();
    var i=0;
    $('.allotted').each(function()
        {
        var v_json= {
                    "row":$(this).data('row'),
                    "col":$(this).data('col'),
                    "vid":$(this).data('vid')
                    };
        roster_array[i]=v_json;
        i=i+1;
        //alert(roster_dets[i-1].vid);
        });
    var roster_dets={"array":roster_array};
    $.ajax(
            {
            type: "POST",
            url: "{{=URL(c='roster', f='roster_submit', args=[table_id, instance_id])}}",
            data: roster_dets
            }).done(function( msg ) 
                {
                $("#flash_message").html(msg);
                });
    });
    
});
</script>
<link href="/{{=request.application}}/static/styles/S3/roster.css" rel="stylesheet" type="text/css" media="screen" charset="utf-8" />
</head>
<body>
<div id="maincontent">
<h1>{{=message}}</h1>
<span>
<div id="r_varea">
<div id="r_varea_head">Volunteers:</div>
{{=IMG(_src='/eden/static/img/cross.png', _alt='cross', _id='cross')}}
<br/>
    <div class='vn' id='vn'>
        <form>
        <input type='text' id='volunteer_quick_search'>
        </form>
            {{for v_id in volunteers:}}
                <div class="volunteer_names" id={{=v_id}}>{{=volunteers[v_id]}}</div>
            {{pass}}
    </div>
</div>
</span>
<span style="position:absolute; left:30px;">
<div id="r_tablearea">
<form enctype="multipart/form-data" id="table_info_form" method="post">
    <div id="selectboxes">
        <!---
        <span>Event:
            <select name='event' id='event' >
            {{for x in range(len(event)):}}
                <option value={{=x}} 
                {{if defaults[0] and x == int(defaults[0]):}}
                    selected="selected"
                {{pass}}
                >{{=event[x]}}</option>
            {{pass}}
            </select>
        </span>

        <span style="position:relative; left:60px;">
            <select name='project_selector' id='project_selector'>
            {{for x in range(len(projects)):}}
                <option value={{=projects[x][0]}}
                {{if defaults[1] and projects[x][0] == int(defaults[1]):}}
                    selected="selected"
                {{pass}}
                >{{=projects[x][1]}}</option>
            {{pass}}
            </select>
        </span>
        -->
        <span>
            <select name='timeframe' id='timeframe'>
            {{for i in range(numb):}}
                <option value={{=i}}
                    {{if defaults[2] and i == int(defaults[2]):}}
                        selected="selected"
                    {{pass}}
                >Week {{=i+1}} {{=project_date}} {{project_date = project_date + datetime.timedelta(days = 6)}} {{=project_date}}{{project_date=project_date+datetime.timedelta(days=1)}}
                </option>
            {{pass}}
            </select>
        </span>

        <span style="position:relative; left:130px;">
        Slot:
            <select name='timeslot' id='timeslot'>
            {{for x in range(len(slots)):}}
                <option value={{=x}}
                    {{if defaults[3] and x == int(defaults[3]):}}
                        selected="selected"
                    {{pass}}
                >{{=slots[x]}}</option>
            {{pass}}
            </select>
        </span>
<!--        <span style="position:relative; left:290px;">
            <a href='index/pdf'>{{=IMG(_src='/eden/static/img/silk/printer.png')}}</a>
            </span>-->
    </div>
</form>
<br/>
<table id="r_table">
<thead>
    <tr>
        <th>Role</th>{{for d in time_dets:}}<th>{{=d}}</th>{{pass}}
    </tr>
</thead>
{{for r in range(len(alloted_roles)):}}
<tr>
    <td>
        <div class='vcell' data-pos={{=r}}>
        {{=alloted_roles[r]}}
            {{=IMG(_src='/eden/static/img/minus.png', _class='symbv remrole')}}
        </div>
    </td>
    {{for c in range(len(time_dets)):}}
    <td>
        {{ is_filled=False}}
        {{ for filled_slot in filled_slots: }}
            {{if r==filled_slot['row'] and c==filled_slot['col']:}}
                <div class='vcell allotted' data-col={{=c}} data-row={{=r}} data-vid={{=filled_slot['vid']}}> 
                    <div class='vcelln'>{{=volunteers[filled_slot['vid']]}} </div>
                    <div class='scelln'> </div> 
                    {{ is_filled=True}}
                    {{=IMG(_src='/eden/static/img/plus.png',_alt='adds',_class='adds symbv addpf')}}
                    {{=IMG(_src='/eden/static/img/minus.png',_alt='rems',_class='rems symbv rempf')}}
                </div>
            {{pass}}
        {{pass}}
        {{ if not is_filled:}}
                <div class='vcell' data-col={{=c}} data-row={{=r}} >
                    <div class='vcelln'></div>
                    <div class='scelln'> </div> 
                    {{=IMG(_src='/eden/static/img/plus.png',_alt='adds',_class='adds symbv')}}
                    {{=IMG(_src='/eden/static/img/minus.png',_alt='rems',_class='rems symbv')}}
                </div> 
        {{pass}}

    </td>
    {{pass}}
</tr>
{{pass}}

<tr id='newrole'><td>
<form enctype="multipart/form-data" id="roster_info_form" action="{{=URL(c='roster', f='add_role', args=[table_id, instance_id])}}" method="post">
<select name="new_job_role" id="new_job_role">
{{for x in range(len(job_roles)):}}<option value={{=x}}>{{=job_roles[x]}}</option>{{pass}}
</select></form></td>
{{for x in range(len(time_dets)):}}<td></td>{{pass}}
</tr>
</table>
{{=IMG(_src='/eden/static/img/plus.png',_alt='addrow',_id='addrow')}}
<br/>
<span style="position:absolute;left:500px;"> <div style="background:#2A2;height:15px;width:35px;"></div> Assigned </span> <span style="position:absolute;left:600px;"> <div style="background:#C22;height:15px;width:35px;"></div> Required </span> <span style="position:absolute;left:700px;"> <div style="background:#CCC;height:15px;width:35px;"></div> Optional </span><br/>
<span> <input type="button" value="Save" id='save'/> </span> <span> <a href="{{=URL(c='roster', f='index', args=[table_id, instance_id])}}">Cancel</a> </span> <span> <a href="{{=URL(c='roster', f='reset', args=[table_id, instance_id])}}">Reset</a> </span> <!--<span> <a>Autofill</a> </span> --> <span style="position:relative;left:650px;background:#FF0" id="flash_message"></span>

</div>
</span>
</div>
</body>
